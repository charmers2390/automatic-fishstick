<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CLU Tracking</title>
<style>
  :root { --bg:#0b0f14; --card:#121922; --accent:#6ee7ff; --text:#e6f0ff; --muted:#94a3b8; --error:#ff6b6b; --ok:#34d399; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
         background: linear-gradient(180deg,#0b0f14 0%, #0d1320 100%); color:var(--text); }
  header { position:sticky; top:0; z-index:10; background:rgba(9,14,22,.75); backdrop-filter: blur(8px);
           border-bottom:1px solid #1e293b; }
  .bar { max-width:980px; margin:0 auto; display:flex; gap:.5rem; align-items:center; padding:.65rem .8rem; }
  .app-title { font-weight:700; letter-spacing:.2px; margin-right: .6rem; }
  .spacer { flex:1; }
  .btn { appearance:none; border:1px solid #1f2937; padding:.5rem .7rem; border-radius:.6rem; cursor:pointer;
         background:#0f172a; color:var(--text); transition:.15s transform ease, .15s background;
         font-weight:600; }
  .btn:hover { transform: translateY(-1px); background:#111b33; }
  .btn:active { transform: translateY(0); }
  .btn.ghost { background:transparent; border-color:#22304a; }
  .container { max-width: 980px; margin: 1.2rem auto 2.4rem; padding: 0 .8rem; }
  .card { background:var(--card); border:1px solid #1e293b; border-radius: 14px; padding: 1rem; }
  .stack { display:grid; gap:1rem; }
  .row { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
  label { font-size:.9rem; color:var(--muted); }
  input[type="text"] { background:#0d1320; border:1px solid #22304a; color:var(--text); border-radius:.6rem;
                       padding:.65rem .7rem; width:100%; outline:none; }
  input[type="text"]::placeholder{ color:#64748b; }
  .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
  .pill { display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .55rem; border:1px solid #22304a;
          border-radius:999px; font-size:.8rem; color:#cbd5e1; background:#0d1320; }
  .accent { color:var(--accent); }
  .error { color:var(--error); }
  .ok { color:var(--ok); }
  .status { border-left:3px solid #23314a; padding-left:.75rem; margin:.25rem 0; }
  .muted { color:var(--muted); }
  .small { font-size:.9rem; }
  .divider { height:1px; background:#1e293b; margin:.5rem 0 1rem; }
  .hint { font-size:.85rem; color:var(--muted); }
  .hidden { display:none !important; }
  .toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 18px; background:#0f172a;
           border:1px solid #1e293b; padding:.6rem .8rem; border-radius:10px; }
  .code { background:#0b1220; border:1px dashed #22304a; padding:.35rem .5rem; border-radius:.5rem; }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="app-title">CLU Tracking</div>
    <button id="btnCreate" class="btn">Create tracking</button>
    <button id="btnAdd" class="btn ghost" title="Add a new status to a tracked code">Add update</button>
    <div class="spacer"></div>
    <span class="pill">PIN required for actions</span>
  </div>
</header>

<main class="container">
  <div class="stack">
    <section class="card">
      <div class="row">
        <div style="flex:1;">
          <label for="code">Enter tracking code (format <span class="mono">CHM-123-12345678</span>)</label>
          <input id="code" type="text" class="mono" placeholder="CHM-123-12345678" inputmode="latin" autocomplete="off" spellcheck="false">
        </div>
        <div>
          <button id="btnTrack" class="btn">Track</button>
        </div>
      </div>
      <div class="hint">Only codes that match the exact template are accepted. Use “Create tracking” to generate a new code.</div>
      <div id="feedback" class="small" style="margin-top:.5rem;"></div>
      <div class="divider"></div>
      <div id="results" class="hidden">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div class="muted small">Tracking code</div>
            <div id="resCode" class="mono accent" style="font-size:1.1rem;"></div>
          </div>
          <div>
            <div class="muted small">Last update</div>
            <div id="resLast" class="mono"></div>
          </div>
        </div>
        <div class="divider"></div>
        <div>
          <div class="muted small" style="margin-bottom:.4rem;">History</div>
          <div id="history"></div>
        </div>
      </div>
    </section>
  </div>
</main>

<div id="toast" class="toast hidden"></div>

<script>
(function(){
  const PIN = "0431"; // 4-digit PIN
  const CODE_RE = /^CHM-\d{3}-\d{8}$/; // required template
  const BACKEND = "https://clu-2.onrender.com";

  const $ = sel => document.querySelector(sel);
  const feedback = $("#feedback");
  function setFeedback(msg, kind=""){ 
    feedback.className = "small " + (kind==="error" ? "error" : kind==="ok" ? "ok" : "muted");
    feedback.textContent = msg || "";
  }
  function toast(msg){
    const t = $("#toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    setTimeout(()=> t.classList.add("hidden"), 2000);
  }
  function formatTime(ts){
    try {
      const d = new Date(ts);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    } catch(e) { return String(ts); }
  }

  async function api(path, opts){
    const url = `${BACKEND}${path}`;
    const res = await fetch(url, Object.assign({ headers: { "Content-Type":"application/json" }}, opts));
    if(!res.ok){
      const err = await res.json().catch(()=>({error:res.statusText}));
      throw new Error(err.error || "Request failed");
    }
    return res.json();
  }

  function renderTrackingData(code, updates){
    const results = $("#results");
    const resCode = $("#resCode");
    const resLast = $("#resLast");
    const history = $("#history");
    const last = updates[updates.length - 1];

    resCode.textContent = code;
    resLast.textContent = last ? `${formatTime(last.ts)} — ${last.text}` : "No updates yet";

    history.innerHTML = "";
    [...updates].reverse().forEach(u => {
      const div = document.createElement("div");
      div.className = "status";
      const t = document.createElement("div");
      t.className = "mono small muted";
      t.textContent = formatTime(u.ts);
      const m = document.createElement("div");
      m.className = "mono";
      m.textContent = u.text;
      div.appendChild(t);
      div.appendChild(m);
      history.appendChild(div);
    });
    results.classList.remove("hidden");
  }

  async function createTracking(){
    const p = prompt("Enter 4-digit PIN:") || "";
    if(p.trim() !== PIN){ toast("PIN incorrect"); return; }

    const initialText = prompt("Enter the first tracking update (e.g., 'Label created'):", "Label created") || "Label created";
    try {
      const data = await api("/api/create", { method:"POST", body: JSON.stringify({ pin: PIN, initialText }) });
      $("#code").value = data.code;
      renderTrackingData(data.code, data.updates);
      toast(`Created ${data.code}`);
    } catch(e){ setFeedback(e.message, "error"); }
  }

  async function addUpdate(){
    const p = prompt("Enter 4-digit PIN:") || "";
    if(p.trim() !== PIN){ toast("PIN incorrect"); return; }

    let code = ($("#resCode").textContent || $("#code").value || "").trim();
    if(!CODE_RE.test(code)){
      code = prompt("Enter a tracking code to update (format CHM-123-12345678):", code).trim();
    }
    if(!CODE_RE.test(code)){ setFeedback("Invalid code format. Must match CHM-123-12345678.", "error"); return; }

    const text = prompt("Enter the new tracking status (e.g., 'In transit — Franklin, TN'):", "In transit — Franklin, TN");
    if(!text) return;

    try {
      const data = await api("/api/add", { method:"POST", body: JSON.stringify({ pin: PIN, code, text }) });
      renderTrackingData(code, data.updates);
      toast("Update added");
    } catch(e){ setFeedback(e.message, "error"); }
  }

  async function track(){
    const code = ($("#code").value || "").trim();
    if(!CODE_RE.test(code)){
      setFeedback("Code must match template CHM-123-12345678.", "error");
      $("#results").classList.add("hidden");
      return;
    }
    try {
      const data = await api(`/api/track/${encodeURIComponent(code)}`);
      renderTrackingData(data.code, data.updates);
      setFeedback("Showing current status.", "ok");

      const link = await api(`/api/share-link?code=${encodeURIComponent(code)}`);
      window.location.href = link.fullUrl || (BACKEND + link.url);
    } catch(e){
      setFeedback(e.message, "error");
      $("#results").classList.add("hidden");
    }
  }

  (async function handleSharedView(){
    const raw = window.location.search;
    if (!raw || raw.length < 2) return;
    const parts = raw.substring(1).split("/");
    const kv = {};
    for (const p of parts){
      const idx = p.indexOf("=");
      if (idx > 0){
        const k = decodeURIComponent(p.slice(0, idx));
        const v = decodeURIComponent(p.slice(idx+1));
        kv[k] = v;
      }
    }
    if (kv.trackingcode && kv.token){
      try {
        const data = await api(`/api/shared?trackingcode=${encodeURIComponent(kv.trackingcode)}&token=${encodeURIComponent(kv.token)}`);
        $("#code").value = data.code;
        renderTrackingData(data.code, data.updates);
        setFeedback("Shared tracking link opened.", "ok");
      } catch(e){ setFeedback(e.message, "error"); }
    }
  })();

  $("#btnCreate").addEventListener("click", createTracking);
  $("#btnAdd").addEventListener("click", addUpdate);
  $("#btnTrack").addEventListener("click", track);
  $("#code").addEventListener("keydown", (e)=>{ if(e.key === "Enter") track(); });

})();</script>
</body>
</html>
