
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CLU Tracking</title>
  <style>
    :root{ --bg:#1e1e2f; --panel:#2c2c3c; --ink:#fff; --muted:#cfd3dc; --accent:#0073e6; --accent2:#005bb5; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--ink); }
    header{ background:#111; padding:16px; text-align:center; font-weight:700; letter-spacing:.2px; }
    nav{ display:flex; position:sticky; top:0; background:#222; z-index:2 }
    nav button{ flex:1; padding:14px 10px; background:#222; color:#fff; border:0; cursor:pointer; font-weight:600 }
    nav button.active{ background:var(--accent) }
    .wrap{ max-width:720px; margin:28px auto; padding:0 16px }
    .tab{ display:none; background:var(--panel); padding:20px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.25) }
    .tab.active{ display:block }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    input[type="text"], input[type="password"]{ flex:1 1 260px; min-width:240px; background:#1f1f2e; color:var(--ink); border:1px solid #3a3a4d; border-radius:6px; padding:12px }
    button.action{ background:var(--accent); border:0; color:#fff; padding:12px 16px; border-radius:6px; cursor:pointer; font-weight:700 }
    button.action:hover{ background:var(--accent2) }
    .log{ margin-top:14px; background:#181822; border:1px solid #303049; border-radius:8px; padding:12px; color:var(--muted); white-space:pre-wrap; word-break:break-word }
    .status{ margin-top:10px; padding:12px; background:#26263a; border-left:4px solid var(--accent); border-radius:6px }
    .status div:first-child{ font-weight:600; margin-bottom:4px; }
    .status div:last-child{ font-size:13px; color:#aaa; }
    .ok{ background:#1f3a26; border-left-color:#2db84d; color:#cdebd6 }
    .err{ background:#3a1f1f; border-left-color:#e35c5c; color:#ffd5d5 }
    small.hint{ color:#aeb4c4 }
    .locationbar{ margin-top:16px; padding:10px; background:#181822; border:1px solid #303049; border-radius:8px; font-family:monospace; white-space:nowrap; overflow:auto }
  </style>
</head>
<body>
  <header>Charmers Logistics Union</header>
  <nav>
    <button class="active" onclick="showTab(event,'track')">CLU Tracking</button>
    <button onclick="showTab(event,'create')">Create Tracking</button>
    <button onclick="showTab(event,'update')">Update Tracking</button>
  </nav>

  <div class="wrap">
    <!-- TRACK -->
    <section id="tab-track" class="tab active">
      <h2>Track a Package</h2>
      <div class="row">
        <input id="trackingInput" type="text" placeholder="CHM-123-12345678" />
        <button class="action" onclick="trackPackage()">Track</button>
      </div>
      <div id="locPath" class="locationbar">/track/</div>
      <div id="trackOut" class="log">Enter a tracking number to see status history.</div>
    </section>

    <!-- CREATE -->
    <section id="tab-create" class="tab">
      <h2>Create Tracking</h2>
      <div class="row">
        <input id="pin1" type="password" placeholder="PIN" />
        <input id="status1" type="text" placeholder="Initial Status (e.g., Order Created)" />
        <button class="action" onclick="createTracking()">Create</button>
      </div>
      <div id="createOut" class="log">Provide a PIN and an initial status, then press Create.</div>
    </section>

    <!-- UPDATE -->
    <section id="tab-update" class="tab">
      <h2>Update Tracking</h2>
      <div class="row">
        <input id="pin2" type="password" placeholder="PIN" />
        <input id="utracking" type="text" placeholder="Tracking Number (CHM-123-12345678)" />
        <input id="ustatus" type="text" placeholder="New Status (e.g., In Transit)" />
        <button class="action" onclick="updateTracking()">Update</button>
      </div>
      <div id="updateOut" class="log">Enter PIN, tracking number, and new status, then press Update.</div>
    </section>
  </div>

  <script>
    const ABSOLUTE_BACKEND = "https://clu-2.onrender.com";

    async function apiFetch(path, options){
      try{
        const r = await fetch(path, options);
        return { ok: r.ok, status: r.status, text: await r.text() };
      }catch(e){}
      try{
        const url = ABSOLUTE_BACKEND + path.replace(/^\/api/, "");
        const r2 = await fetch(url, options);
        return { ok: r2.ok, status: r2.status, text: await r2.text() };
      }catch(e2){
        return { ok:false, status:0, text:"Request failed" };
      }
    }

    function showTab(ev, name){
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      ev.currentTarget.classList.add('active');
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-'+name).classList.add('active');
    }

    function validFormat(code){
      return /^CHM-\d{3}-\d{8}$/.test(code);
    }

    function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randChunk(len){
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let out = "";
      for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function bigRandomString(){
      let parts = [];
      for(let i=0;i<6;i++){ parts.push(randChunk(randInt(16, 40))); }
      return parts.join("/");
    }
    function buildFancyPath(tracking){
      return "/track/?Tracking/search="+tracking+
             "/token=path/"+bigRandomString()+
             "/tokenid/takefrom/Ttp/token.txt/"+
             bigRandomString()+"/"+bigRandomString();
    }
    function updateLocationBar(tracking){
      const fancy = buildFancyPath(tracking);
      document.getElementById("locPath").textContent = fancy;
      try{ history.replaceState(null, "", fancy); }catch(e){}
    }
    function parseTrackingFromUrl(){
      try{
        const href = window.location.href;
        const afterTrack = href.split("/track/")[1] || "";
        if(afterTrack){
          const m = afterTrack.match(/search=([A-Za-z0-9\-]+)/);
          if(m && validFormat(m[1])) return m[1];
        }
        const url = new URL(href);
        const q = url.searchParams.get("tracking");
        if(q && validFormat(q)) return q;
      }catch(e){}
      return "";
    }

    function renderHistory(json, targetEl, code){
      targetEl.innerHTML = ""; 
      if(!json || !json.history){
        targetEl.textContent = typeof json === 'string' ? json : 'No data';
        return;
      }

      const header = document.createElement("div");
      header.textContent = "Tracking: " + code;
      header.style.fontWeight = "bold";
      header.style.marginBottom = "10px";
      targetEl.appendChild(header);

      json.history.slice().reverse().forEach(h => {
        const card = document.createElement("div");
        card.className = "status";

        const status = document.createElement("div");
        status.textContent = h.status || "";

        const time = document.createElement("div");
        time.textContent = h.time ? new Date(h.time).toLocaleString() : "";

        card.appendChild(status);
        card.appendChild(time);
        targetEl.appendChild(card);
      });
    }

    async function trackPackage(){
      const code = document.getElementById('trackingInput').value.trim();
      const out = document.getElementById('trackOut');
      if(!validFormat(code)){ out.textContent = "Format must be CHM-123-12345678"; return; }
      out.textContent = "Loading...";
      const r = await apiFetch(`/api/track/${encodeURIComponent(code)}`);
      try{
        const json = JSON.parse(r.text);
        if(json.error){ out.textContent = json.error; return; }
        renderHistory(json, out, code);
        updateLocationBar(code);
      }catch{
        out.textContent = r.text || "No response";
      }
    }

    async function createTracking(){
      const pin = document.getElementById('pin1').value;
      const status = document.getElementById('status1').value;
      const out = document.getElementById('createOut');
      out.textContent = "Creating...";
      const r = await apiFetch(`/api/create`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ pin, status })
      });
      try{
        const json = JSON.parse(r.text);
        if(json.error){ out.textContent = json.error; return; }
        const tn = json.trackingNumber || "(unknown)";
        out.textContent = `Created: ${tn}`;
      }catch{
        out.textContent = r.text || "No response";
      }
    }

    async function updateTracking(){
      const pin = document.getElementById('pin2').value;
      const trackingNumber = document.getElementById('utracking').value;
      const status = document.getElementById('ustatus').value;
      const out = document.getElementById('updateOut');
      out.textContent = "Updating...";
      const r = await apiFetch(`/api/update`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ pin, trackingNumber, status })
      });
      try{
        const json = JSON.parse(r.text);
        if(json.error){ out.textContent = json.error; return; }
        out.textContent = `Updated: ${trackingNumber}`;
      }catch{
        out.textContent = r.text || "No response";
      }
    }

    (function init(){
      const fromUrl = parseTrackingFromUrl();
      if(validFormat(fromUrl)){
        document.getElementById("trackingInput").value = fromUrl;
        trackPackage();
      }
    })();
  </script>
</body>
</html>
