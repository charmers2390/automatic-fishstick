<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CLU Tracking</title>
  <style>
    :root{ --bg:#0f1220; --panel:#191d33; --ink:#eef2ff; --muted:#cbd5e1; --accent:#4f7cff; --accent2:#3a63d6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{background:#0a0d1a;padding:16px;text-align:center;font-weight:700;letter-spacing:.2px}
    nav{display:flex;justify-content:center;background:#121630;position:sticky;top:0;z-index:5}
    nav button{flex:1;max-width:280px;padding:14px 10px;background:transparent;border:0;color:var(--ink);cursor:pointer;font-weight:700}
    nav button.active{background:var(--accent)}
    .wrap{max-width:880px;margin:28px auto;padding:0 16px}
    .tab{display:none;background:var(--panel);padding:20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .tab.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"],input[type="password"],select{
      flex:1 1 240px;min-width:220px;background:#0f1430;color:var(--ink);
      border:1px solid #2b3460;border-radius:8px;padding:12px
    }
    button.action{background:var(--accent);border:0;color:#fff;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:800}
    button.action:hover{background:var(--accent2)}
    .log{margin-top:14px;background:#0d1126;border:1px solid #232b58;border-radius:10px;padding:12px;color:var(--muted);white-space:pre-wrap;word-break:break-word}
    .statuses{margin-top:12px}
    .status{margin:10px 0;padding:12px;background:#11183b;border-left:4px solid var(--accent);border-radius:8px}
    .hint{color:#9aa5c4}
  </style>
</head>
<body>
  <header>Charmers Logistics Union</header>
  <nav>
    <button class="active" onclick="showTab(event,'track')">CLU Tracking</button>
    <button onclick="showTab(event,'create')">Create Tracking</button>
    <button onclick="showTab(event,'update')">Update Tracking</button>
  </nav>

  <div class="wrap">
    <!-- TRACK -->
    <section id="tab-track" class="tab active">
      <h2>Track a Package</h2>
      <div class="row">
        <input id="trackingInput" type="text" placeholder="CHM-123-12345678" />
        <button class="action" onclick="trackPackage()">Track</button>
      </div>
      <div id="trackInfo" class="log hint">Enter a tracking number to see status history.</div>
      <div id="trackStatuses" class="statuses"></div>
    </section>

    <!-- CREATE -->
    <section id="tab-create" class="tab">
      <h2>Create Tracking</h2>
      <div class="row">
        <input id="pin1" type="password" placeholder="PIN" />
        <input id="status1" type="text" placeholder="Initial Status (e.g., Order Created)" />
        <select id="city1" title="Location">
          <option value="Centerville, TN">Centerville, Tennessee</option>
          <option value="Franklin, TN">Franklin, Tennessee</option>
          <option value="Nashville, TN">Nashville, Tennessee</option>
          <option value="Louisville, KY">Louisville, Kentucky</option>
          <option value="Bowling Green, KY">Bowling Green, Kentucky</option>
        </select>
        <button class="action" onclick="createTracking()">Create</button>
      </div>
      <div id="createInfo" class="log hint">Enter PIN, status, and city, then press Create.</div>
    </section>

    <!-- UPDATE -->
    <section id="tab-update" class="tab">
      <h2>Update Tracking</h2>
      <div class="row">
        <input id="pin2" type="password" placeholder="PIN" />
        <input id="utracking" type="text" placeholder="Tracking Number (CHM-123-12345678)" />
        <input id="ustatus" type="text" placeholder="New Status (e.g., In Transit)" />
        <select id="city2" title="Location">
          <option value="Centerville, TN">Centerville, Tennessee</option>
          <option value="Franklin, TN">Franklin, Tennessee</option>
          <option value="Nashville, TN">Nashville, Tennessee</option>
          <option value="Louisville, KY">Louisville, Kentucky</option>
          <option value="Bowling Green, KY">Bowling Green, Kentucky</option>
        </select>
        <button class="action" onclick="updateTracking()">Update</button>
      </div>
      <div id="updateInfo" class="log hint">Enter PIN, tracking number, new status, and city, then press Update.</div>
    </section>
  </div>

  <script>
    const BASE = "https://clu-2.onrender.com"; // absolute backend (works from local file)

    // Normalize input: trim, uppercase, replace Unicode dashes with hyphen, strip spaces/zero-width
    function normalizeCode(raw){
      if(!raw) return "";
      let s = raw.trim().toUpperCase();
      // replace various dashes with ASCII hyphen
      s = s.replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g, "-");
      // remove spaces (including non-breaking) and zero-width characters
      s = s.replace(/[\s\u00A0\u200B\u200C\u200D\u2060]/g, "");
      return s;
    }

    function showTab(ev, name){
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      ev.currentTarget.classList.add('active');
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-'+name).classList.add('active');
    }

    const isValid = s => /^CHM-\d{3}-\d{8}$/.test(s);

    function renderTracking(number, data){
      const info = document.getElementById('trackInfo');
      const list = document.getElementById('trackStatuses');
      info.textContent = "";
      list.innerHTML = "";
      if(!data || data.error){ info.textContent = (data && data.error) ? data.error : ""; return; }
      info.textContent = `Tracking: ${number}`;
      if(Array.isArray(data.history)){
        data.history.slice().reverse().forEach(h => {
          const div = document.createElement('div');
          div.className = "status";
          const t = h.time ? new Date(h.time).toLocaleString() : "";
          div.innerHTML = `<b>${h.status||""}</b><br>${h.location||""}${t ? " â€” " + t : ""}`;
          list.appendChild(div);
        });
      }
    }

    async function trackPackage(){
      const raw = document.getElementById('trackingInput').value;
      const code = normalizeCode(raw);
      const info = document.getElementById('trackInfo');
      const list = document.getElementById('trackStatuses');
      info.classList.remove('hint');
      info.textContent = isValid(code) ? "Loading..." : "Format must be CHM-123-12345678";
      list.innerHTML = "";
      if(!isValid(code)) return;

      // Update visible URL to /example?tracking=CODE (no reload)
      try { history.replaceState(null, "", "/example?tracking=" + encodeURIComponent(code)); } catch(e){}

      try{
        const r = await fetch(`${BASE}/track/${encodeURIComponent(code)}`);
        const txt = await r.text();
        try{ renderTracking(code, JSON.parse(txt)); }catch{ info.textContent = txt; }
      }catch{ info.textContent = "Request failed"; }
    }

    async function createTracking(){
      const pin = document.getElementById('pin1').value;
      const status = document.getElementById('status1').value;
      const location = document.getElementById('city1').value;
      const out = document.getElementById('createInfo');
      out.classList.remove('hint');
      out.textContent = "Creating...";
      try{
        const r = await fetch(`${BASE}/create`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ pin, status, location })
        });
        out.textContent = await r.text();
      }catch{ out.textContent = "Request failed"; }
    }

    async function updateTracking(){
      const pin = document.getElementById('pin2').value;
      const trackingNumber = normalizeCode(document.getElementById('utracking').value);
      const status = document.getElementById('ustatus').value;
      const location = document.getElementById('city2').value;
      const out = document.getElementById('updateInfo');
      out.classList.remove('hint');
      out.textContent = "Updating...";
      try{
        const r = await fetch(`${BASE}/update`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ pin, trackingNumber, status, location })
        });
        out.textContent = await r.text();
      }catch{ out.textContent = "Request failed"; }
    }
  </script>
</body>
</html>
